<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../../img/favicon.ico">
        <title>Image TLS Issue - OpenShift Notes</title>
        <link href="../../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../../css/brands.min.css" rel="stylesheet">
        <link href="../../../css/solid.min.css" rel="stylesheet">
        <link href="../../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../../..">OpenShift Notes</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Git Helper</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="../../../git-helper/ncd-git-backup/" class="dropdown-item">Git Backup</a>
</li>
                                    
<li>
    <a href="../../../git-helper/ncd-git-restore/" class="dropdown-item">Git Restore</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Deployment Scripts</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../../git-helper/Deployment/backupconfig.sh" class="dropdown-item">Backup Config</a>
</li>
            
<li>
    <a href="../../../git-helper/Deployment/newgitserver.sh" class="dropdown-item">New Git Server</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">OpenShift</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Backup & Restore</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../backup-restore/ACM-GEO-RED/" class="dropdown-item">ACM GEO Red</a>
</li>
            
<li>
    <a href="../../backup-restore/ACM-localbackup/" class="dropdown-item">ACM Local Backup</a>
</li>
            
<li>
    <a href="../../backup-restore/AWS-S3/" class="dropdown-item">AWS S3 Backup</a>
</li>
            
<li>
    <a href="../../backup-restore/etcd-backup/" class="dropdown-item">ETCD Backup</a>
</li>
            
<li>
    <a href="../../backup-restore/etcd-restore/" class="dropdown-item">ETCD Restore</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">CNF Onboarding Support</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Image TLS Issue</a>
</li>
            
<li>
    <a href="../oclogin-tls-issue/" class="dropdown-item">OCLogin TLS Issue</a>
</li>
            
<li>
    <a href="../proxy-cache-pod/" class="dropdown-item">Proxy Cache Pod</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../../deployment/readme/" class="dropdown-item">Deployment</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Maintenance</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../maintenace/cluster-stop-start/" class="dropdown-item">Cluster Stop/Start</a>
</li>
            
<li>
    <a href="../../maintenace/reboot-nodes/" class="dropdown-item">Reboot Nodes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Networking</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../networking/metalb-troubleshooting/" class="dropdown-item">MetalLB Troubleshooting</a>
</li>
            
<li>
    <a href="../../networking/metallb-configuration/" class="dropdown-item">MetalLB Configuration</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Storage Management</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../storagemanagement/ceph-rebalanceissue/" class="dropdown-item">Ceph Rebalance Issue</a>
</li>
            
<li>
    <a href="../../storagemanagement/storage-node-replacement/" class="dropdown-item">Storage Node Replacement</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../../tools-management-ts/ts-tools/" class="dropdown-item">Tools Management TS</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Troubleshooting</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../troubleshooting/nsenter/" class="dropdown-item">Nsenter Usage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">User Management</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../usermanagement/remove-kubeadmin/" class="dropdown-item">Remove Kubeadmin</a>
</li>
            
<li>
    <a href="../../usermanagement/user-management/" class="dropdown-item">User Management</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../../backup-restore/etcd-restore/" class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../oclogin-tls-issue/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#container-image-download-issue-due-to-tls-problem" class="nav-link">Container Image download issue due to TLS problem.</a>
              <ul class="nav flex-column">
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="container-image-download-issue-due-to-tls-problem">Container Image download issue due to TLS problem.</h1>
<h3 id="creating-tls-certificate-on-the-ocp-cluster-as-additional-tls-newly">Creating tls certificate on the OCP cluster as additional tls <code>newly</code></h3>
<h4 id="this-step-will-resolve-issue-on-linux-os-levelbastion-host-level">This step will resolve issue on Linux OS level(bastion host level)</h4>
<blockquote>
<p>In order to be able to push images (for example) from the infra node to this Quay, the rootCA certificate shall be put to the trusted list of the client. The Quay is exposed using the OCP’s default ingress controller, route, so its rootCA shall be fetched (if it was not swapped already).</p>
</blockquote>
<ol>
<li>from bastion host, login to respective cluster and find the respective CWL cluster quay url. </li>
</ol>
<pre><code>[root@dom14npv101-infra-manager ~ vlabrc]# oc get route -A |grep -i quay
quay-registry              quay-registry-quay                          quay-registry.apps.ncpvnpvlab1.pnwlab.nsn-rdnet.net                                                             quay-registry-quay-app                             http         edge/Redirect          None
quay-registry              quay-registry-quay-builder                  quay-registry-quay-builder-quay-registry.apps.ncpvnpvlab1.pnwlab.nsn-rdnet.net                                  quay-registry-quay-app                             grpc         edge/Redirect          None
[root@dom14npv101-infra-manager ~ vlabrc]# 
</code></pre>
<ol>
<li>first locally resolve it, so make dir and download the cert (this is resolve on that particular linux server.)</li>
</ol>
<pre><code>[root@dom14npv101-infra-manager ~ vlabrc]# sudo mkdir -p /etc/containers/certs.d/quay-registry.apps.ncpvnpvlab1.pnwlab.nsn-rdnet.net
[root@dom14npv101-infra-manager ~ vlabrc]#
</code></pre>
<ol>
<li>create the ingress certificate to local host </li>
</ol>
<pre><code>[root@dom14npv101-infra-manager ~ vlabrc]# oc get secrets -n openshift-ingress-operator router-ca \
-o jsonpath=&quot;{.data['tls\.crt']}&quot; | base64 -d | \
sudo tee -a \
/etc/containers/certs.d/quay-registry.apps.ncpvnpvlab1.pnwlab.nsn-rdnet.net/ca.crt
-----BEGIN CERTIFICATE-----
MIIDDDCCAfSgAwIBAgIBATANBgkqhkiG9w0BAQsFADAmMSQwIgYDVQQDDBtpbmdy
ZXNzLW9wZXJhdG9yQDE3NDE2MjI1OTkwHhcNMjUwMzEwMTYwMzE4WhcNMjcwMzEw
MTYwMzE5WjAmMSQwIgYDVQQDDBtpbmdyZXNzLW9wZXJhdG9yQDE3NDE2MjI1OTkw
ggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQCtDCDqA6Cx+MvulZtYNleK
T3e4OVlQrR8zytgIQIvlLpeGoqsoNWEe/ZukJ35fco6LA42RcIiI+F5aI6zZ4+F8
81ZEpsSRBx8VUMsZCdkb5mA8tl5vJjV+GC1tRlohk6KWqYoR5VJVLbggFer95efv
xyny/BCYXmU2CSHSmRQRnwAI6cX0K7QgEB0kMHaFjEta16UnwzKdhNbaj5rn0aTm
hLSGYLvPMx9RVZswjqOqrju0Aovfv9ZzzE++e6+KH9/jZr2HepK62ZZdGznbmnzu
Al0D+ILaVj8DiFpcwUIaSaRxUVlphAUmm530GLbKrBdQGSsWcJTo4ixf8R2wYo69
AgMBAAGjRTBDMA4GA1UdDwEB/wQEAwICpDASBgNVHRMBAf8ECDAGAQH/AgEAMB0G
A1UdDgQWBBQMuq1odXMd4OlIU4vG8Kfu/aLltjANBgkqhkiG9w0BAQsFAAOCAQEA
BVerN+fxay+kk9uei+bQIpryakFstJ5ApuB1wDKgLY3LucwbzXhaE48i9TEOoNlB
32ugNpShYQoOyVMMAvQNQG69HNu0KDJHYGDMAs4seGIsMwqityS6Zgv8T3xo176g
mR0y74yiK1ImtnUAaAPt7NNFflhpZafzhY24k4L3AVNEjMKI9B2SgUJAscmXkNIZ
Dri+EILpba6MzmeLdE3sVTaOIRberr6yTKbZQskaci+twaO7r83hD3E3xwGJB823
Zu+B2i/txKbBrFeKUpppfrg7zCsyqM1UwFtenuj1yj3qECJVwe1Lr8SctrzpJc+J
ryyB1JeEPQWwewI1j7QXqg==
-----END CERTIFICATE-----
[root@dom14npv101-infra-manager ~ vlabrc]#

</code></pre>
<h4 id="on-the-ocp-cluster-level-changes-tls-creation">On the OCP cluster level changes, TLS Creation</h4>
<ol>
<li>Similarly if images would be pulled on the HUB cluster, its ingress’ rootCA shall be put into the image.config.openshift.io/cluster CR, as the registry is using self-signed certificate by default and treated as an insecure registry, more precisely the OCP’s ingress (if it is not swapped yet). In order to overcome issues the following commands:</li>
</ol>
<pre><code> [root@dom14npv101-infra-manager ~ vlabrc]# oc get secrets -n openshift-ingress-operator router-ca \
-o jsonpath=&quot;{.data['tls\.crt']}&quot; | base64 -d &gt; ingress_ca.crt
[root@dom14npv101-infra-manager ~ vlabrc]# 
</code></pre>
<ol>
<li>create an cm to enforce the certificate here.</li>
</ol>
<pre><code>[root@dom14npv101-infra-manager ~ vlabrc]# oc create configmap registry-cas -n openshift-config \
--from-file=quay-registry.apps.ncpvnpvlab1.pnwlab.nsn-rdnet.net=ingress_ca.crt
configmap/registry-cas created
[root@dom14npv101-infra-manager ~ vlabrc]# 
</code></pre>
<ol>
<li>now create an image patch to cluster iamge config. </li>
</ol>
<pre><code>[root@dom14npv101-infra-manager ~ vlabrc]# oc patch image.config.openshift.io/cluster --patch '{&quot;spec&quot;:
{&quot;additionalTrustedCA&quot;:{&quot;name&quot;:&quot;registry-cas&quot;}}}' \
--type=merge
image.config.openshift.io/cluster patched
[root@dom14npv101-infra-manager ~ vlabrc]#
</code></pre>
<h3 id="creating-tls-certificate-on-the-ocp-cluster-as-additional-tls-add">Creating tls certificate on the OCP cluster as additional tls <code>ADD</code></h3>
<ol>
<li>oc apply is the preferred way to update an existing resource, including ConfigMaps. This command will update the ConfigMap with the new data while keeping existing data intact. If you don’t have a YAML file, you can first export the current ConfigMap to a file, edit it, and then apply the changes:</li>
</ol>
<pre><code>oc get configmap registry-cas -n openshift-config -o yaml &gt; registry-cas.yaml

oc apply -f registry-cas.yaml
</code></pre>
<ol>
<li>If you need to update the existing ConfigMap with new or modified data directly from the command line, you can force the update with oc create configmap using the --dry-run and --force flags:</li>
</ol>
<pre><code>oc create configmap registry-cas -n openshift-config \
--from-file=harbor.ncdvnpv.ncpvnpvmgt.pnwlab.nsn-rdnet.net=ingress_ca.crt \
--dry-run=client -o yaml | oc replace -f -

</code></pre>
<ol>
<li>Using oc patch (for small changes) Optional extra steps </li>
</ol>
<pre><code>oc patch configmap registry-cas -n openshift-config \
  --type='json' \
  -p='[{&quot;op&quot;: &quot;replace&quot;, &quot;path&quot;: &quot;/data/harbor.ncdvnpv.ncpvnpvmgt.pnwlab.nsn-rdnet.net&quot;, &quot;value&quot;: &quot;ingress_ca.crt&quot;}]'
</code></pre></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../../js/base.js"></script>
        <script src="../../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
