# Backing up Nokia Git Server
> this procedure, works for NCD 24.9 mp1 pp1. 


## Instructions on backing up Nokia Git Server


### backup utility will generate the following outputs

* database.sql file containing the PostgreSQL database content
* Git repository data
* Kubernetes secrets required for the upgrade
* backup_information.yml generated by the backup tool

1. Example of backup_information.yml

```
:db_version: 20240508085441
:backup_created_at: 2024-06-13 13:57:08 +0000
:gitlab_version: 17.0.1
:tar_version: tar (GNU tar) 1.34
:installation_type: gitlab-helm-chart
:skipped: builds,pages,registry,uploads,artifacts,lfs,packages,
external_diffs,terraform_state,pages,ci_secure_files
:repositories_server_side: false
```



### Prerequisites

* To back up Nokia Git Server and the necessary Helm plugins for Backup and Recovery (CBUR), CBUR must be installed on your cluster.
* CBUR must be enabled in the Nokia Git Server installation.

##### remove plugins for helm (backup and restore)

1. login to bastion host and login to cluster here .

```

[root@ncputility ~]# source /root/panhubrc
WARNING: Using insecure TLS client config. Setting this option is not supported!

Login successful.

You have access to 101 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project "default".
[root@ncputility ~ panhub_rc]$
```

2. list of plugins installed on helm here.
```
[root@ncputility ~ panhub_rc]$ helm plugin list
NAME    VERSION DESCRIPTION
backup  0.1.2   backup/restore releases in a namespace to/from a file
[root@ncputility ~ panhub_rc]$

```
3. remove using following command on helm `#helm plugin remove backup`

```
[root@ncputility ~ panhub_rc]$ helm plugin remove backup
Uninstalled plugin: backup
[root@ncputility ~ panhub_rc]$

```


#### Install plugins for helm (backup and restore)

1. login to bastion host and login to cluster here .

```

[root@ncputility ~]# source /root/panhubrc
WARNING: Using insecure TLS client config. Setting this option is not supported!

Login successful.

You have access to 101 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project "default".
[root@ncputility ~ panhub_rc]$
```

2. list of plugins installed on helm here.
```
[root@ncputility ~ panhub_rc]$ helm plugin list
NAME    VERSION DESCRIPTION
[root@ncputility ~ panhub_rc]$

```
3. Install the latest version of the Helm backup and restore plugins.

> For the Helm backup and restore plugins, use the version that is compatible with the respective Backup and Recovery chart release.

```
[root@ncputility ~ panhub_rc]$ export HELM_HOME=$HOME/.helm
[root@ncputility ~ panhub_rc]$ cd
[root@ncputility ~ panhub_rc]$ WORK_DIR=`mktemp -d`
[root@ncputility ~ panhub_rc]$ mkdir -p $WORK_DIR/backup
[root@ncputility ~ panhub_rc]$ mkdir -p $WORK_DIR/restore
[root@ncputility ~ panhub_rc]$ tar xf /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/INSTALL_MEDIA/backup-3.7.4.tgz -C $WORK_DIR/backup
[root@ncputility ~ panhub_rc]$ tar xf /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/INSTALL_MEDIA/restore-3.7.4.tgz -C $WORK_DIR/restore
[root@ncputility ~ panhub_rc]$ helm plugin install $WORK_DIR/backup
Installed plugin: backup
[root@ncputility ~ panhub_rc]$ helm plugin install $WORK_DIR/restore
Installed plugin: restore
[root@ncputility ~ panhub_rc]$ rm -rf $WORK_DIR
[root@ncputility ~ panhub_rc]$

```
    a. check the status of installed helm plugins. 

    ```
    [root@ncputility ~ panhub_rc]$ helm plugin list
    NAME    VERSION DESCRIPTION
    backup  3.7.4   Plugin responsible for the backup of helm releases and k8s namespaces with CBUR.
    restore 3.7.4   Plugin responsible for restoring helm releases and k8s namespaces with CBUR.
    [root@ncputility ~ panhub_rc]$ 
    ```



4. Configure RBAC for CRDs. (only when you deploy using tenant credentials)

> For tenants only using Backup and Recovery, permission to read, create, modify and delete BrPolicy and BrHook is sufficient. However, tenants installing their own namespaces for Backup and Recovery also need permission to read brpolices/status.


```
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: admin:brpolices
  labels:
    rbac.authorization.k8s.io/aggregate-to-admin: "true"
    rbac.authorization.k8s.io/aggregate-to-edit: "true"
rules:
- apiGroups: ["cbur.csf.nokia.com"]
  resources: ["brpolices", "brhooks"]
  verbs: ["get", "list", "watch", "create", "update", "patch", "delete"]
- apiGroups: ["cbur.csf.nokia.com"]
  resources: ["brpolices/status"]
  verbs: ["get", "list", "watch", "update", "patch"]
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: view:brpolices
  labels:
    rbac.authorization.k8s.io/aggregate-to-view: "true"
rules:
- apiGroups: ["cbur.csf.nokia.com"]
  resources: ["brpolices", "brhooks", "brpolices/status"]
  verbs: ["get", "list", "watch"]
```

### Backup Nokia Git Server

> Notes:

```
The CBUR master service (CBUR_MASTER_SERVICE) must be specified in either of the following formats:
http(s)://dns_name:port
http(s)://ipv4:port
http(s)://[ipv6]:port
http(s)://dns_name
http(s)://ingress/ingresspath
```

> here is the command to run the backup of git server 

```
helm backup -t ncd-git -a none -n paclypancdgit01 -x http://172.20.8.113:80

helm backup -n paclypancdgit01 -t ncd-git -a none -x http://172.20.8.113:80
```


1. login to bastion host and login to cluster here .

```

[root@ncputility ~]# source /root/panhubrc
WARNING: Using insecure TLS client config. Setting this option is not supported!

Login successful.

You have access to 101 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project "default".
[root@ncputility ~ panhub_rc]$
```
2. Find the `namespace` and `release` name of git server and cbut details from here 'helm list -A '
```
[root@ncputility ~ panhub_rc]$ helm list  -A
NAME            NAMESPACE               REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
cbur-crds       paclypancdcbur01        1               2025-02-27 14:18:04.313208995 -0500 EST deployed        cbur-crds-2.6.0                         2.6.0
ncd-cbur        paclypancdcbur01        1               2025-02-27 14:24:56.578242699 -0500 EST deployed        cbur-1.18.1                             1.13.1
ncd-git         paclypancdgit01         1               2025-02-27 14:45:25.489107042 -0500 EST deployed        ncd-git-server-24.9.1-7.g30f1acf        17.3.3
ncd-postgresql  paclypancddb01          1               2025-02-27 14:30:27.65639258 -0500 EST  deployed        postgresql-ha-24.9.1-1009.g19e2a92      24.9.1-1009.g19e2a92
ncd-redis       paclypancddb01          1               2025-02-27 14:37:11.651840036 -0500 EST deployed        ncd-redis-24.9.1-1009.g19e2a92          24.9.1-1009.g19e2a92
[root@ncputility ~ panhub_rc]$

```

3. trigger the backup job using following command here 

> Uri should be having `cbur` structure name in it 


```
[root@ncputility ~ panhub_rc]$ helm backup -n paclypancdgit01 -a none -t ncd-git -x http://cbur.apps.panclyphub01.mnc020.mcc714/cbur
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Success",
  "message": "backupHelmRelease task = a80ed466-254c-4644-8d19-9a0cdf813fbe is on!",
  "reason": "",
  "details": {
    "a80ed466-254c-4644-8d19-9a0cdf813fbe": {
      "name": "ncd-git",
      "namespace": "paclypancdgit01",
      "timestamp": "20250402104554",
      "backup_data": {},
      "helm_version": 3,
      "request": "backupHelmRelease"
    }
  },
  "code": 202
}
[root@ncputility ~ panhub_rc]$ 

```

4. here is an example with `--verbose` mode  (optinal for troubleshooting)

```
[root@ncputility ~ panhub_rc]$ helm backup -n paclypancdgit01 -a none -t ncd-git -x http://cbur.apps.panclyphub01.mnc020.mcc714/cbur --verbose
*******
+ exit_func 0
+ '[' -d /tmp/certs.1974896 ']'
+ rm -rf /tmp/certs.1974896
+ exit 0
[root@ncputility ~ panhub_rc]$
```

5.  check the status of the backup using cbur br policy status


```
[root@ncputility ~ panhub_rc]$ kubectl -n paclypancdgit01 get brpolices.cbur.csf.nokia.com ncd-git-toolbox
NAME              AGE
ncd-git-toolbox   33d
[root@ncputility ~ panhub_rc]$ kubectl -n paclypancdgit01 get brpolices.cbur.csf.nokia.com ncd-git-toolbox -o yaml
[root@ncputility ~ panhub_rc]$

```

6. look for backup files exported. , right now backup files are saved locally on the gitserver(paclypancdgit01) `namespace` within `ncd-git-toolbox` pod. 

> but we need this backup files to be saved outside the cluster, like sftp server or something, so that we can restore it on new git server.

```
[root@ncputility ~ panhub_rc]$ oc -n paclypancdgit01 exec -it ncd-git-toolbox-56b88dd4c7-27hb5 -- bash
Defaulted container "toolbox" out of: toolbox, cbura-sidecar, certificates (init), configure (init)
git@ncd-git-toolbox-56b88dd4c7-27hb5:/$ cd /srv/gitlab/tmp/backups
git@ncd-git-toolbox-56b88dd4c7-27hb5:/srv/gitlab/tmp/backups$ ls
backup_information.yml  db  repositories
git@ncd-git-toolbox-56b88dd4c7-27hb5:/srv/gitlab/tmp/backups$ ls -la
total 4
drwxr-sr-x. 4 git  git  66 Apr  2 10:46 .
drwxrwsrwx. 3 root git  21 Apr  2 10:46 ..
-rw-r--r--. 1 git  git 318 Apr  2 10:46 backup_information.yml
drwxr-sr-x. 2 git  git  29 Apr  2 10:46 db
drwx--S---. 4 git  git  38 Apr  2 10:46 repositories
git@ncd-git-toolbox-56b88dd4c7-27hb5:/srv/gitlab/tmp/backups$

```

#### Creating user for remote backup 

1. login to the `linux` host and used `useradd` and `passwd` commands to create `user and password` here 
```
[root@ncputility ~ panhub_rc]$ useradd gitserverbackup
[root@ncputility ~ panhub_rc]$ passwd gitserverbackup
Changing password for user gitserverbackup.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: all authentication tokens updated successfully.
[root@ncputility ~ panhub_rc]$
```
2. create a public key on the new user authrazation file.
```
[root@ncputility ~ pancwl_rc]$ su - gitserverbackup
[gitserverbackup@ncputility ~]$ pwd
/home/gitserverbackup
[gitserverbackup@ncputility ~]$ 
[gitserverbackup@ncputility ~]$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/gitserverbackup/.ssh/id_rsa):
Created directory '/home/gitserverbackup/.ssh'.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/gitserverbackup/.ssh/id_rsa
Your public key has been saved in /home/gitserverbackup/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:oF5K3Ky1tLDmb5ALID4FXyLPnlTtX97ZpJyFE0r3Z2A gitserverbackup@ncputility.panclyphub01.mnc020.mcc714
The key's randomart image is:
+---[RSA 3072]----+
|      .          |
| o . o .   . oE  |
|  * + o   . o.+. |
|o  B + o   o o +o|
|o.+ *.* S o o O..|
| o.=oO o . . * . |
|  ..*oo          |
|   o. .          |
|    .o.          |
+----[SHA256]-----+
[gitserverbackup@ncputility ~]$
```
3. take copy of the cbur public using following oc command

```
[root@ncputility ~ panhub_rc]$ helm list -A
NAME            NAMESPACE               REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
cbur-crds       paclypancdcbur01        1               2025-02-27 14:18:04.313208995 -0500 EST deployed        cbur-crds-2.6.0                         2.6.0
ncd-cbur        paclypancdcbur01        2               2025-04-02 04:17:30.755392541 -0500 EST deployed        cbur-1.18.1                             1.13.1
ncd-git         paclypancdgit01         1               2025-02-27 14:45:25.489107042 -0500 EST deployed        ncd-git-server-24.9.1-7.g30f1acf        17.3.3
ncd-postgresql  paclypancddb01          1               2025-02-27 14:30:27.65639258 -0500 EST  deployed        postgresql-ha-24.9.1-1009.g19e2a92      24.9.1-1009.g19e2a92
ncd-redis       paclypancddb01          1               2025-02-27 14:37:11.651840036 -0500 EST deployed        ncd-redis-24.9.1-1009.g19e2a92          24.9.1-1009.g19e2a92
[root@ncputility ~ panhub_rc]$
[root@ncputility ~ panhub_rc]$ oc get secret -n paclypancdcbur01 cburm-ssh-public-key -o jsonpath={.data.ssh_public_key} | base64 -d
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDUH73f7kf8ey2UEkgeN/IJbEBDJPgricRlsD7d7pB0RAQGLx/fNZT15VRX2qOvLydsTbtcxz28Uzryy5zAmAB9z0zGuYKaSo80bS7bXjIsKc71fGD6NvvfSBBLQ1GCk0mFIjn06XmkRJOgqtgOvq66HQEcGSJQ6jq3NQzGERe+VrCk1VWbyfr0vtqqasmKChgr0dAh+0f07lUdpbR9XzEnOG20LNCAcffEBPXXccSEz/huPHOV0Kjfe7rtaKj5ZoIkFlFETPTz4HoKPlZcfxp/s94yICXk++TiI9+mF2SVYuEUWqx00p1DTa79dmUncTaz1c5nshaq4bNdJcPkoDdp[root@ncputility ~ panhub_rc]$

```

4. here i am using ssh-copy-id command to auto create an authzation file 


```
[gitserverbackup@ncputility ~]$ ssh-copy-id localhost
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: "/home/gitserverbackup/.ssh/id_rsa.pub"
The authenticity of host 'localhost (::1)' can't be established.
ED25519 key fingerprint is SHA256:KXMGNVqIYHOtvcd+VqGq/5d/t5UWWGKxPVkuffCOD9I.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
gitserverbackup@localhost's password:

Number of key(s) added: 1

Now try logging into the machine, with:   "ssh 'localhost'"
and check to make sure that only the key(s) you wanted were added.

[gitserverbackup@ncputility ~]$ cd .ssh/
[gitserverbackup@ncputility .ssh]$ ll
total 20
-rw-------. 1 gitserverbackup gitserverbackup  607 Apr  2 08:14 authorized_keys
-rw-------. 1 gitserverbackup gitserverbackup 2655 Apr  2 08:14 id_rsa
-rw-r--r--. 1 gitserverbackup gitserverbackup  607 Apr  2 08:14 id_rsa.pub
-rw-------. 1 gitserverbackup gitserverbackup  825 Apr  2 08:14 known_hosts
-rw-r--r--. 1 gitserverbackup gitserverbackup   91 Apr  2 08:14 known_hosts.old
[gitserverbackup@ncputility .ssh]$ vi authorized_keys   #<- this updated based on step.3 output>
[gitserverbackup@ncputility .ssh]$
```

### Creating remote backup on NCD git 

1. Create an git server backup on a remote server, so create a secret with sftp details. 


```
[root@ncputility ~ panhub_rc]$ oc create secret generic bastionhostpan \
  --namespace=paclypancdcbur01 \
  --from-literal=port="22" \
  --from-literal=host="10.89.100.66" \
  --from-literal=mode="sftp" \
  --from-literal=username="gitserverbackup" \
  --from-literal=path="/home/gitserverbackup" \
  --from-literal=strictHostKeyChecking="no" \
  --from-literal=hostKey=""
secret/bastionhostpan created
[root@ncputility ~ panhub_rc]$
```
2. make sure, it's avaiable via get command. 
```
[root@ncputility ~ panhub_rc]$ oc  get secret -n paclypancdcbur01
NAME                              TYPE                             DATA   AGE
bastionhostpan                    Opaque                           7      10s
cbur-redis                        Opaque                           1      33d
cburm-ssh-public-key              Opaque                           1      33d
my-pull-secret                    kubernetes.io/dockerconfigjson   1      33d
sh.helm.release.v1.cbur-crds.v1   helm.sh/release.v1               1      33d
sh.helm.release.v1.ncd-cbur.v1    helm.sh/release.v1               1      33d
sh.helm.release.v1.ncd-cbur.v2    helm.sh/release.v1               1      4h14m
sh.helm.release.v1.ncd-cbur.v3    helm.sh/release.v1               1      14m
[root@ncputility ~ panhub_rc]$

```
#### update on the git cbur side. 

1. get the backup of cbur repo values file. and update the ssh:credentialName 


```
[root@ncputility ~ panhub_rc]$ helm get values ncd-cbur -n paclypancdcbur01 >  rr.yaml
[root@ncputility ~ panhub_rc]$

SSH:
  credentialName: bastionhostpan

[root@ncputility ~ panhub_rc]$ helm upgrade ncd-cbur -n paclypancdcbur01 /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/helmcharts/cbur-1.18.1.tgz -f rr.yaml --debug

```

2. Similar to git cbur modification, need to update the git=server chart as well. 

```
[root@ncputility ~ panhub_rc]$ helm get values ncd-git -n paclypancdgit01 > rr.yaml
[root@ncputility ~ panhub_rc]$

update:

cbur:
  brPolicy:
    apiVersion: cbur.csf.nokia.com/v1
    spec:
      autoEnableCron: false
      autoUpdateCron: false
      backend:
        mode: sftp
      cronSpec: 0 0 * * *
      dataEncryption:
        enable: false
      ignoreFileChanged: false
      maxiCopy: 3
      weight: 5

[root@ncputility ~ panhub_rc]$  helm upgrade ncd-git -n paclypancdgit01 /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/helmcharts/ncd-git-server-24.9.1-7.g30f1acf.tgz -f rr.yaml --debug --timeout 20m
```
3. validate there is no pods are in pending or crashloop error here .


#### Trigger the backup on remote desination 

1.  using follow method to trigger  the backup 

```
[root@ncputility ~ panhub_rc]$ helm backup -n paclypancdgit01 -a none -t ncd-git -x http://cbur.apps.panclyphub01.mnc020.mcc714/cbur --backend sftp --verbose

[root@ncputility ~ panhub_rc]$
```

2.  login to that SFTP server and check for backup files.

```
[gitserverbackup@ncputility 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox]$ pwd
/home/gitserverbackup/BACKUP/sftp/paclypancdgit01/DEPLOYMENT_ncd-git-toolbox/20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox
[gitserverbackup@ncputility 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox]$ ll
total 2476
-rw-r--r--. 1 gitserverbackup gitserverbackup    7846 Apr  2 08:40 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox_Secrets.tar.gz
-rw-r--r--. 1 gitserverbackup gitserverbackup 2523279 Apr  2 08:41 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox_volume.tar.gz
[gitserverbackup@ncputility 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox]$

```

#### Troubleshooting

##### Certificate error 

1. copy crt file used during installation.

```
[root@ncputility denmark]# cp -rp ca.crt /etc/pki/ca-trust/source/anchors/
[root@ncputility denmark]# sudo update-ca-trust
[root@ncputility denmark]#
```


##### backup job failure 

1. if Error looks like this, then problem on the namespace spoce. 

```
[root@ncputility ~ hn_hub_rc]$ helm backup -n hnevocdgit01 -a none -t ncd-git -x http://cbur.apps.hnevocphub01.mnc002.mcc708/cbur
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Failure",
  "message": "Failed to get helm release ncd-git in namespace hnevocdgit01",
  "reason": "",
  "details": {},
  "code": 500
}
[root@ncputility ~ hn_hub_rc]$ 
```
2. to resolve this issue, get the values file and update the namespace scope list.  include git-server namespace too. 

```
[root@ncputility ~ hn_hub_rc]$ helm get values ncd-cbur  -n hnevocdcbur01 > rr.yaml

```

3. retry it, it will work now

```
[root@ncputility ~ hn_hub_rc]$ helm backup -n hnevocdgit01 -a none -t ncd-git -x http://cbur.apps.hnevocphub01.mnc002.mcc708/cbur
{
  "kind": "Status",
  "apiVersion": "v1",
  "metadata": {},
  "status": "Success",
  "message": "backupHelmRelease task = cc857932-d83d-4e2d-9493-1252595da3f2 is on!",
  "reason": "",
  "details": {
    "cc857932-d83d-4e2d-9493-1252595da3f2": {
      "name": "ncd-git",
      "namespace": "hnevocdgit01",
      "timestamp": "20250403005800",
      "backup_data": {},
      "helm_version": 3,
      "request": "backupHelmRelease"
    }
  },
  "code": 202
}
[root@ncputility ~ hn_hub_rc]$

```

#### Reference 

1.  NCDFM tickets
* https://jiradc2.ext.net.nokia.com/browse/NCDFM-3023