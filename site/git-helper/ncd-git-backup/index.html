<!DOCTYPE html>
<html lang="en" data-bs-theme="light">
    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        
        
        
        <link rel="shortcut icon" href="../../img/favicon.ico">
        <title>Git Backup - OpenShift Notes</title>
        <link href="../../css/bootstrap.min.css" rel="stylesheet">
        <link href="../../css/fontawesome.min.css" rel="stylesheet">
        <link href="../../css/brands.min.css" rel="stylesheet">
        <link href="../../css/solid.min.css" rel="stylesheet">
        <link href="../../css/v4-font-face.min.css" rel="stylesheet">
        <link href="../../css/base.css" rel="stylesheet">
        <link id="hljs-light" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css" >
        <link id="hljs-dark" rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github-dark.min.css" disabled>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
        <script>hljs.highlightAll();</script> 
    </head>

    <body>
        <div class="navbar fixed-top navbar-expand-lg navbar-dark bg-primary">
            <div class="container">
                <a class="navbar-brand" href="../..">OpenShift Notes</a>
                <!-- Expander button -->
                <button type="button" class="navbar-toggler" data-bs-toggle="collapse" data-bs-target="#navbar-collapse" aria-controls="navbar-collapse" aria-expanded="false" aria-label="Toggle navigation">
                    <span class="navbar-toggler-icon"></span>
                </button>

                <!-- Expanded navigation -->
                <div id="navbar-collapse" class="navbar-collapse collapse">
                        <!-- Main navigation -->
                        <ul class="nav navbar-nav">
                            <li class="nav-item">
                                <a href="../.." class="nav-link">Home</a>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle active" aria-current="page" role="button" data-bs-toggle="dropdown"  aria-expanded="false">Git Helper</a>
                                <ul class="dropdown-menu">
                                    
<li>
    <a href="./" class="dropdown-item active" aria-current="page">Git Backup</a>
</li>
                                    
<li>
    <a href="../ncd-git-restore/" class="dropdown-item">Git Restore</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Deployment Scripts</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../Deployment/backupconfig.sh" class="dropdown-item">Backup Config</a>
</li>
            
<li>
    <a href="../Deployment/newgitserver.sh" class="dropdown-item">New Git Server</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                            <li class="nav-item dropdown">
                                <a href="#" class="nav-link dropdown-toggle" role="button" data-bs-toggle="dropdown"  aria-expanded="false">OpenShift</a>
                                <ul class="dropdown-menu">
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Backup & Restore</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../openshift/backup-restore/ACM-GEO-RED/" class="dropdown-item">ACM GEO Red</a>
</li>
            
<li>
    <a href="../../openshift/backup-restore/ACM-localbackup/" class="dropdown-item">ACM Local Backup</a>
</li>
            
<li>
    <a href="../../openshift/backup-restore/AWS-S3/" class="dropdown-item">AWS S3 Backup</a>
</li>
            
<li>
    <a href="../../openshift/backup-restore/etcd-backup/" class="dropdown-item">ETCD Backup</a>
</li>
            
<li>
    <a href="../../openshift/backup-restore/etcd-restore/" class="dropdown-item">ETCD Restore</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">CNF Onboarding Support</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../openshift/CNF-onboarding-support/image-tls-issue/" class="dropdown-item">Image TLS Issue</a>
</li>
            
<li>
    <a href="../../openshift/CNF-onboarding-support/oclogin-tls-issue/" class="dropdown-item">OCLogin TLS Issue</a>
</li>
            
<li>
    <a href="../../openshift/CNF-onboarding-support/proxy-cache-pod/" class="dropdown-item">Proxy Cache Pod</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../../openshift/deployment/readme/" class="dropdown-item">Deployment</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Maintenance</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../openshift/maintenace/cluster-stop-start/" class="dropdown-item">Cluster Stop/Start</a>
</li>
            
<li>
    <a href="../../openshift/maintenace/reboot-nodes/" class="dropdown-item">Reboot Nodes</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Networking</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../openshift/networking/metalb-troubleshooting/" class="dropdown-item">MetalLB Troubleshooting</a>
</li>
            
<li>
    <a href="../../openshift/networking/metallb-configuration/" class="dropdown-item">MetalLB Configuration</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Storage Management</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../openshift/storagemanagement/ceph-rebalanceissue/" class="dropdown-item">Ceph Rebalance Issue</a>
</li>
            
<li>
    <a href="../../openshift/storagemanagement/storage-node-replacement/" class="dropdown-item">Storage Node Replacement</a>
</li>
    </ul>
  </li>
                                    
<li>
    <a href="../../openshift/tools-management-ts/ts-tools/" class="dropdown-item">Tools Management TS</a>
</li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">Troubleshooting</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../openshift/troubleshooting/nsenter/" class="dropdown-item">Nsenter Usage</a>
</li>
    </ul>
  </li>
                                    
  <li class="dropdown-submenu">
    <a href="#" class="dropdown-item">User Management</a>
    <ul class="dropdown-menu">
            
<li>
    <a href="../../openshift/usermanagement/remove-kubeadmin/" class="dropdown-item">Remove Kubeadmin</a>
</li>
            
<li>
    <a href="../../openshift/usermanagement/user-management/" class="dropdown-item">User Management</a>
</li>
    </ul>
  </li>
                                </ul>
                            </li>
                        </ul>

                    <ul class="nav navbar-nav ms-md-auto">
                        <li class="nav-item">
                            <a href="#" class="nav-link" data-bs-toggle="modal" data-bs-target="#mkdocs_search_modal">
                                <i class="fa fa-search"></i> Search
                            </a>
                        </li>
                            <li class="nav-item">
                                <a rel="prev" href="../.." class="nav-link">
                                    <i class="fa fa-arrow-left"></i> Previous
                                </a>
                            </li>
                            <li class="nav-item">
                                <a rel="next" href="../ncd-git-restore/" class="nav-link">
                                    Next <i class="fa fa-arrow-right"></i>
                                </a>
                            </li>
                    </ul>
                </div>
            </div>
        </div>

        <div class="container">
            <div class="row">
                    <div class="col-md-3"><div class="navbar-expand-md bs-sidebar hidden-print affix" role="complementary">
    <div class="navbar-header">
        <button type="button" class="navbar-toggler collapsed" data-bs-toggle="collapse" data-bs-target="#toc-collapse" title="Table of Contents">
            <span class="fa fa-angle-down"></span>
        </button>
    </div>

    
    <div id="toc-collapse" class="navbar-collapse collapse card bg-body-tertiary">
        <ul class="nav flex-column">
            
            <li class="nav-item" data-bs-level="1"><a href="#backing-up-nokia-git-server" class="nav-link">Backing up Nokia Git Server</a>
              <ul class="nav flex-column">
            <li class="nav-item" data-bs-level="2"><a href="#instructions-on-backing-up-nokia-git-server" class="nav-link">Instructions on backing up Nokia Git Server</a>
              <ul class="nav flex-column">
              </ul>
            </li>
              </ul>
            </li>
        </ul>
    </div>
</div></div>
                    <div class="col-md-9" role="main">

<h1 id="backing-up-nokia-git-server">Backing up Nokia Git Server</h1>
<blockquote>
<p>this procedure, works for NCD 24.9 mp1 pp1. </p>
</blockquote>
<h2 id="instructions-on-backing-up-nokia-git-server">Instructions on backing up Nokia Git Server</h2>
<h3 id="backup-utility-will-generate-the-following-outputs">backup utility will generate the following outputs</h3>
<ul>
<li>database.sql file containing the PostgreSQL database content</li>
<li>Git repository data</li>
<li>Kubernetes secrets required for the upgrade</li>
<li>
<p>backup_information.yml generated by the backup tool</p>
</li>
<li>
<p>Example of backup_information.yml</p>
</li>
</ul>
<pre><code>:db_version: 20240508085441
:backup_created_at: 2024-06-13 13:57:08 +0000
:gitlab_version: 17.0.1
:tar_version: tar (GNU tar) 1.34
:installation_type: gitlab-helm-chart
:skipped: builds,pages,registry,uploads,artifacts,lfs,packages,
external_diffs,terraform_state,pages,ci_secure_files
:repositories_server_side: false
</code></pre>
<h3 id="prerequisites">Prerequisites</h3>
<ul>
<li>To back up Nokia Git Server and the necessary Helm plugins for Backup and Recovery (CBUR), CBUR must be installed on your cluster.</li>
<li>CBUR must be enabled in the Nokia Git Server installation.</li>
</ul>
<h5 id="remove-plugins-for-helm-backup-and-restore">remove plugins for helm (backup and restore)</h5>
<ol>
<li>login to bastion host and login to cluster here .</li>
</ol>
<pre><code>
[root@ncputility ~]# source /root/panhubrc
WARNING: Using insecure TLS client config. Setting this option is not supported!

Login successful.

You have access to 101 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project &quot;default&quot;.
[root@ncputility ~ panhub_rc]$
</code></pre>
<ol>
<li>list of plugins installed on helm here.</li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm plugin list
NAME    VERSION DESCRIPTION
backup  0.1.2   backup/restore releases in a namespace to/from a file
[root@ncputility ~ panhub_rc]$

</code></pre>
<ol>
<li>remove using following command on helm <code>#helm plugin remove backup</code></li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm plugin remove backup
Uninstalled plugin: backup
[root@ncputility ~ panhub_rc]$

</code></pre>
<h4 id="install-plugins-for-helm-backup-and-restore">Install plugins for helm (backup and restore)</h4>
<ol>
<li>login to bastion host and login to cluster here .</li>
</ol>
<pre><code>
[root@ncputility ~]# source /root/panhubrc
WARNING: Using insecure TLS client config. Setting this option is not supported!

Login successful.

You have access to 101 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project &quot;default&quot;.
[root@ncputility ~ panhub_rc]$
</code></pre>
<ol>
<li>list of plugins installed on helm here.</li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm plugin list
NAME    VERSION DESCRIPTION
[root@ncputility ~ panhub_rc]$

</code></pre>
<ol>
<li>Install the latest version of the Helm backup and restore plugins.</li>
</ol>
<blockquote>
<p>For the Helm backup and restore plugins, use the version that is compatible with the respective Backup and Recovery chart release.</p>
</blockquote>
<pre><code>[root@ncputility ~ panhub_rc]$ export HELM_HOME=$HOME/.helm
[root@ncputility ~ panhub_rc]$ cd
[root@ncputility ~ panhub_rc]$ WORK_DIR=`mktemp -d`
[root@ncputility ~ panhub_rc]$ mkdir -p $WORK_DIR/backup
[root@ncputility ~ panhub_rc]$ mkdir -p $WORK_DIR/restore
[root@ncputility ~ panhub_rc]$ tar xf /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/INSTALL_MEDIA/backup-3.7.4.tgz -C $WORK_DIR/backup
[root@ncputility ~ panhub_rc]$ tar xf /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/INSTALL_MEDIA/restore-3.7.4.tgz -C $WORK_DIR/restore
[root@ncputility ~ panhub_rc]$ helm plugin install $WORK_DIR/backup
Installed plugin: backup
[root@ncputility ~ panhub_rc]$ helm plugin install $WORK_DIR/restore
Installed plugin: restore
[root@ncputility ~ panhub_rc]$ rm -rf $WORK_DIR
[root@ncputility ~ panhub_rc]$

</code></pre>
<pre><code>a. check the status of installed helm plugins.

```
[root@ncputility ~ panhub_rc]$ helm plugin list
NAME    VERSION DESCRIPTION
backup  3.7.4   Plugin responsible for the backup of helm releases and k8s namespaces with CBUR.
restore 3.7.4   Plugin responsible for restoring helm releases and k8s namespaces with CBUR.
[root@ncputility ~ panhub_rc]$ 
```
</code></pre>
<ol>
<li>Configure RBAC for CRDs. (only when you deploy using tenant credentials)</li>
</ol>
<blockquote>
<p>For tenants only using Backup and Recovery, permission to read, create, modify and delete BrPolicy and BrHook is sufficient. However, tenants installing their own namespaces for Backup and Recovery also need permission to read brpolices/status.</p>
</blockquote>
<pre><code>kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: admin:brpolices
  labels:
    rbac.authorization.k8s.io/aggregate-to-admin: &quot;true&quot;
    rbac.authorization.k8s.io/aggregate-to-edit: &quot;true&quot;
rules:
- apiGroups: [&quot;cbur.csf.nokia.com&quot;]
  resources: [&quot;brpolices&quot;, &quot;brhooks&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;, &quot;delete&quot;]
- apiGroups: [&quot;cbur.csf.nokia.com&quot;]
  resources: [&quot;brpolices/status&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;, &quot;patch&quot;]
---
kind: ClusterRole
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: view:brpolices
  labels:
    rbac.authorization.k8s.io/aggregate-to-view: &quot;true&quot;
rules:
- apiGroups: [&quot;cbur.csf.nokia.com&quot;]
  resources: [&quot;brpolices&quot;, &quot;brhooks&quot;, &quot;brpolices/status&quot;]
  verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]
</code></pre>
<h3 id="backup-nokia-git-server">Backup Nokia Git Server</h3>
<blockquote>
<p>Notes:</p>
</blockquote>
<pre><code>The CBUR master service (CBUR_MASTER_SERVICE) must be specified in either of the following formats:
http(s)://dns_name:port
http(s)://ipv4:port
http(s)://[ipv6]:port
http(s)://dns_name
http(s)://ingress/ingresspath
</code></pre>
<blockquote>
<p>here is the command to run the backup of git server </p>
</blockquote>
<pre><code>helm backup -t ncd-git -a none -n paclypancdgit01 -x http://172.20.8.113:80

helm backup -n paclypancdgit01 -t ncd-git -a none -x http://172.20.8.113:80
</code></pre>
<ol>
<li>login to bastion host and login to cluster here .</li>
</ol>
<pre><code>
[root@ncputility ~]# source /root/panhubrc
WARNING: Using insecure TLS client config. Setting this option is not supported!

Login successful.

You have access to 101 projects, the list has been suppressed. You can list all projects with 'oc projects'

Using project &quot;default&quot;.
[root@ncputility ~ panhub_rc]$
</code></pre>
<ol>
<li>Find the <code>namespace</code> and <code>release</code> name of git server and cbut details from here 'helm list -A '</li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm list  -A
NAME            NAMESPACE               REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
cbur-crds       paclypancdcbur01        1               2025-02-27 14:18:04.313208995 -0500 EST deployed        cbur-crds-2.6.0                         2.6.0
ncd-cbur        paclypancdcbur01        1               2025-02-27 14:24:56.578242699 -0500 EST deployed        cbur-1.18.1                             1.13.1
ncd-git         paclypancdgit01         1               2025-02-27 14:45:25.489107042 -0500 EST deployed        ncd-git-server-24.9.1-7.g30f1acf        17.3.3
ncd-postgresql  paclypancddb01          1               2025-02-27 14:30:27.65639258 -0500 EST  deployed        postgresql-ha-24.9.1-1009.g19e2a92      24.9.1-1009.g19e2a92
ncd-redis       paclypancddb01          1               2025-02-27 14:37:11.651840036 -0500 EST deployed        ncd-redis-24.9.1-1009.g19e2a92          24.9.1-1009.g19e2a92
[root@ncputility ~ panhub_rc]$

</code></pre>
<ol>
<li>trigger the backup job using following command here </li>
</ol>
<blockquote>
<p>Uri should be having <code>cbur</code> structure name in it </p>
</blockquote>
<pre><code>[root@ncputility ~ panhub_rc]$ helm backup -n paclypancdgit01 -a none -t ncd-git -x http://cbur.apps.panclyphub01.mnc020.mcc714/cbur
{
  &quot;kind&quot;: &quot;Status&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {},
  &quot;status&quot;: &quot;Success&quot;,
  &quot;message&quot;: &quot;backupHelmRelease task = a80ed466-254c-4644-8d19-9a0cdf813fbe is on!&quot;,
  &quot;reason&quot;: &quot;&quot;,
  &quot;details&quot;: {
    &quot;a80ed466-254c-4644-8d19-9a0cdf813fbe&quot;: {
      &quot;name&quot;: &quot;ncd-git&quot;,
      &quot;namespace&quot;: &quot;paclypancdgit01&quot;,
      &quot;timestamp&quot;: &quot;20250402104554&quot;,
      &quot;backup_data&quot;: {},
      &quot;helm_version&quot;: 3,
      &quot;request&quot;: &quot;backupHelmRelease&quot;
    }
  },
  &quot;code&quot;: 202
}
[root@ncputility ~ panhub_rc]$ 

</code></pre>
<ol>
<li>here is an example with <code>--verbose</code> mode  (optinal for troubleshooting)</li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm backup -n paclypancdgit01 -a none -t ncd-git -x http://cbur.apps.panclyphub01.mnc020.mcc714/cbur --verbose
*******
+ exit_func 0
+ '[' -d /tmp/certs.1974896 ']'
+ rm -rf /tmp/certs.1974896
+ exit 0
[root@ncputility ~ panhub_rc]$
</code></pre>
<ol>
<li>check the status of the backup using cbur br policy status</li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ kubectl -n paclypancdgit01 get brpolices.cbur.csf.nokia.com ncd-git-toolbox
NAME              AGE
ncd-git-toolbox   33d
[root@ncputility ~ panhub_rc]$ kubectl -n paclypancdgit01 get brpolices.cbur.csf.nokia.com ncd-git-toolbox -o yaml
[root@ncputility ~ panhub_rc]$

</code></pre>
<ol>
<li>look for backup files exported. , right now backup files are saved locally on the gitserver(paclypancdgit01) <code>namespace</code> within <code>ncd-git-toolbox</code> pod. </li>
</ol>
<blockquote>
<p>but we need this backup files to be saved outside the cluster, like sftp server or something, so that we can restore it on new git server.</p>
</blockquote>
<pre><code>[root@ncputility ~ panhub_rc]$ oc -n paclypancdgit01 exec -it ncd-git-toolbox-56b88dd4c7-27hb5 -- bash
Defaulted container &quot;toolbox&quot; out of: toolbox, cbura-sidecar, certificates (init), configure (init)
git@ncd-git-toolbox-56b88dd4c7-27hb5:/$ cd /srv/gitlab/tmp/backups
git@ncd-git-toolbox-56b88dd4c7-27hb5:/srv/gitlab/tmp/backups$ ls
backup_information.yml  db  repositories
git@ncd-git-toolbox-56b88dd4c7-27hb5:/srv/gitlab/tmp/backups$ ls -la
total 4
drwxr-sr-x. 4 git  git  66 Apr  2 10:46 .
drwxrwsrwx. 3 root git  21 Apr  2 10:46 ..
-rw-r--r--. 1 git  git 318 Apr  2 10:46 backup_information.yml
drwxr-sr-x. 2 git  git  29 Apr  2 10:46 db
drwx--S---. 4 git  git  38 Apr  2 10:46 repositories
git@ncd-git-toolbox-56b88dd4c7-27hb5:/srv/gitlab/tmp/backups$

</code></pre>
<h4 id="creating-user-for-remote-backup">Creating user for remote backup</h4>
<ol>
<li>login to the <code>linux</code> host and used <code>useradd</code> and <code>passwd</code> commands to create <code>user and password</code> here </li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ useradd gitserverbackup
[root@ncputility ~ panhub_rc]$ passwd gitserverbackup
Changing password for user gitserverbackup.
New password:
BAD PASSWORD: The password is shorter than 8 characters
Retype new password:
passwd: all authentication tokens updated successfully.
[root@ncputility ~ panhub_rc]$
</code></pre>
<ol>
<li>create a public key on the new user authrazation file.</li>
</ol>
<pre><code>[root@ncputility ~ pancwl_rc]$ su - gitserverbackup
[gitserverbackup@ncputility ~]$ pwd
/home/gitserverbackup
[gitserverbackup@ncputility ~]$ 
[gitserverbackup@ncputility ~]$ ssh-keygen -t rsa
Generating public/private rsa key pair.
Enter file in which to save the key (/home/gitserverbackup/.ssh/id_rsa):
Created directory '/home/gitserverbackup/.ssh'.
Enter passphrase (empty for no passphrase):
Enter same passphrase again:
Your identification has been saved in /home/gitserverbackup/.ssh/id_rsa
Your public key has been saved in /home/gitserverbackup/.ssh/id_rsa.pub
The key fingerprint is:
SHA256:oF5K3Ky1tLDmb5ALID4FXyLPnlTtX97ZpJyFE0r3Z2A gitserverbackup@ncputility.panclyphub01.mnc020.mcc714
The key's randomart image is:
+---[RSA 3072]----+
|      .          |
| o . o .   . oE  |
|  * + o   . o.+. |
|o  B + o   o o +o|
|o.+ *.* S o o O..|
| o.=oO o . . * . |
|  ..*oo          |
|   o. .          |
|    .o.          |
+----[SHA256]-----+
[gitserverbackup@ncputility ~]$
</code></pre>
<ol>
<li>take copy of the cbur public using following oc command</li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm list -A
NAME            NAMESPACE               REVISION        UPDATED                                 STATUS          CHART                                   APP VERSION
cbur-crds       paclypancdcbur01        1               2025-02-27 14:18:04.313208995 -0500 EST deployed        cbur-crds-2.6.0                         2.6.0
ncd-cbur        paclypancdcbur01        2               2025-04-02 04:17:30.755392541 -0500 EST deployed        cbur-1.18.1                             1.13.1
ncd-git         paclypancdgit01         1               2025-02-27 14:45:25.489107042 -0500 EST deployed        ncd-git-server-24.9.1-7.g30f1acf        17.3.3
ncd-postgresql  paclypancddb01          1               2025-02-27 14:30:27.65639258 -0500 EST  deployed        postgresql-ha-24.9.1-1009.g19e2a92      24.9.1-1009.g19e2a92
ncd-redis       paclypancddb01          1               2025-02-27 14:37:11.651840036 -0500 EST deployed        ncd-redis-24.9.1-1009.g19e2a92          24.9.1-1009.g19e2a92
[root@ncputility ~ panhub_rc]$
[root@ncputility ~ panhub_rc]$ oc get secret -n paclypancdcbur01 cburm-ssh-public-key -o jsonpath={.data.ssh_public_key} | base64 -d
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDUH73f7kf8ey2UEkgeN/IJbEBDJPgricRlsD7d7pB0RAQGLx/fNZT15VRX2qOvLydsTbtcxz28Uzryy5zAmAB9z0zGuYKaSo80bS7bXjIsKc71fGD6NvvfSBBLQ1GCk0mFIjn06XmkRJOgqtgOvq66HQEcGSJQ6jq3NQzGERe+VrCk1VWbyfr0vtqqasmKChgr0dAh+0f07lUdpbR9XzEnOG20LNCAcffEBPXXccSEz/huPHOV0Kjfe7rtaKj5ZoIkFlFETPTz4HoKPlZcfxp/s94yICXk++TiI9+mF2SVYuEUWqx00p1DTa79dmUncTaz1c5nshaq4bNdJcPkoDdp[root@ncputility ~ panhub_rc]$

</code></pre>
<ol>
<li>here i am using ssh-copy-id command to auto create an authzation file </li>
</ol>
<pre><code>[gitserverbackup@ncputility ~]$ ssh-copy-id localhost
/usr/bin/ssh-copy-id: INFO: Source of key(s) to be installed: &quot;/home/gitserverbackup/.ssh/id_rsa.pub&quot;
The authenticity of host 'localhost (::1)' can't be established.
ED25519 key fingerprint is SHA256:KXMGNVqIYHOtvcd+VqGq/5d/t5UWWGKxPVkuffCOD9I.
This key is not known by any other names
Are you sure you want to continue connecting (yes/no/[fingerprint])? yes
/usr/bin/ssh-copy-id: INFO: attempting to log in with the new key(s), to filter out any that are already installed
/usr/bin/ssh-copy-id: INFO: 1 key(s) remain to be installed -- if you are prompted now it is to install the new keys
gitserverbackup@localhost's password:

Number of key(s) added: 1

Now try logging into the machine, with:   &quot;ssh 'localhost'&quot;
and check to make sure that only the key(s) you wanted were added.

[gitserverbackup@ncputility ~]$ cd .ssh/
[gitserverbackup@ncputility .ssh]$ ll
total 20
-rw-------. 1 gitserverbackup gitserverbackup  607 Apr  2 08:14 authorized_keys
-rw-------. 1 gitserverbackup gitserverbackup 2655 Apr  2 08:14 id_rsa
-rw-r--r--. 1 gitserverbackup gitserverbackup  607 Apr  2 08:14 id_rsa.pub
-rw-------. 1 gitserverbackup gitserverbackup  825 Apr  2 08:14 known_hosts
-rw-r--r--. 1 gitserverbackup gitserverbackup   91 Apr  2 08:14 known_hosts.old
[gitserverbackup@ncputility .ssh]$ vi authorized_keys   #&lt;- this updated based on step.3 output&gt;
[gitserverbackup@ncputility .ssh]$
</code></pre>
<h3 id="creating-remote-backup-on-ncd-git">Creating remote backup on NCD git</h3>
<ol>
<li>Create an git server backup on a remote server, so create a secret with sftp details. </li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ oc create secret generic bastionhostpan \
  --namespace=paclypancdcbur01 \
  --from-literal=port=&quot;22&quot; \
  --from-literal=host=&quot;10.89.100.66&quot; \
  --from-literal=mode=&quot;sftp&quot; \
  --from-literal=username=&quot;gitserverbackup&quot; \
  --from-literal=path=&quot;/home/gitserverbackup&quot; \
  --from-literal=strictHostKeyChecking=&quot;no&quot; \
  --from-literal=hostKey=&quot;&quot;
secret/bastionhostpan created
[root@ncputility ~ panhub_rc]$
</code></pre>
<ol>
<li>make sure, it's avaiable via get command. </li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ oc  get secret -n paclypancdcbur01
NAME                              TYPE                             DATA   AGE
bastionhostpan                    Opaque                           7      10s
cbur-redis                        Opaque                           1      33d
cburm-ssh-public-key              Opaque                           1      33d
my-pull-secret                    kubernetes.io/dockerconfigjson   1      33d
sh.helm.release.v1.cbur-crds.v1   helm.sh/release.v1               1      33d
sh.helm.release.v1.ncd-cbur.v1    helm.sh/release.v1               1      33d
sh.helm.release.v1.ncd-cbur.v2    helm.sh/release.v1               1      4h14m
sh.helm.release.v1.ncd-cbur.v3    helm.sh/release.v1               1      14m
[root@ncputility ~ panhub_rc]$

</code></pre>
<h4 id="update-on-the-git-cbur-side">update on the git cbur side.</h4>
<ol>
<li>get the backup of cbur repo values file. and update the ssh:credentialName </li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm get values ncd-cbur -n paclypancdcbur01 &gt;  rr.yaml
[root@ncputility ~ panhub_rc]$

SSH:
  credentialName: bastionhostpan

[root@ncputility ~ panhub_rc]$ helm upgrade ncd-cbur -n paclypancdcbur01 /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/helmcharts/cbur-1.18.1.tgz -f rr.yaml --debug

</code></pre>
<ol>
<li>Similar to git cbur modification, need to update the git=server chart as well. </li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm get values ncd-git -n paclypancdgit01 &gt; rr.yaml
[root@ncputility ~ panhub_rc]$

update:

cbur:
  brPolicy:
    apiVersion: cbur.csf.nokia.com/v1
    spec:
      autoEnableCron: false
      autoUpdateCron: false
      backend:
        mode: sftp
      cronSpec: 0 0 * * *
      dataEncryption:
        enable: false
      ignoreFileChanged: false
      maxiCopy: 3
      weight: 5

[root@ncputility ~ panhub_rc]$  helm upgrade ncd-git -n paclypancdgit01 /root/ncd/NCD_24.9_Git_Server_ORB-RC/ncd-git-server-product/helmcharts/ncd-git-server-24.9.1-7.g30f1acf.tgz -f rr.yaml --debug --timeout 20m
</code></pre>
<ol>
<li>validate there is no pods are in pending or crashloop error here .</li>
</ol>
<h4 id="trigger-the-backup-on-remote-desination">Trigger the backup on remote desination</h4>
<ol>
<li>using follow method to trigger  the backup </li>
</ol>
<pre><code>[root@ncputility ~ panhub_rc]$ helm backup -n paclypancdgit01 -a none -t ncd-git -x http://cbur.apps.panclyphub01.mnc020.mcc714/cbur --backend sftp --verbose

[root@ncputility ~ panhub_rc]$
</code></pre>
<ol>
<li>login to that SFTP server and check for backup files.</li>
</ol>
<pre><code>[gitserverbackup@ncputility 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox]$ pwd
/home/gitserverbackup/BACKUP/sftp/paclypancdgit01/DEPLOYMENT_ncd-git-toolbox/20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox
[gitserverbackup@ncputility 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox]$ ll
total 2476
-rw-r--r--. 1 gitserverbackup gitserverbackup    7846 Apr  2 08:40 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox_Secrets.tar.gz
-rw-r--r--. 1 gitserverbackup gitserverbackup 2523279 Apr  2 08:41 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox_volume.tar.gz
[gitserverbackup@ncputility 20250402134019_SFTP_paclypancdgit01_ncd-git-toolbox]$

</code></pre>
<h4 id="troubleshooting">Troubleshooting</h4>
<h5 id="certificate-error">Certificate error</h5>
<ol>
<li>copy crt file used during installation.</li>
</ol>
<pre><code>[root@ncputility denmark]# cp -rp ca.crt /etc/pki/ca-trust/source/anchors/
[root@ncputility denmark]# sudo update-ca-trust
[root@ncputility denmark]#
</code></pre>
<h5 id="backup-job-failure">backup job failure</h5>
<ol>
<li>if Error looks like this, then problem on the namespace spoce. </li>
</ol>
<pre><code>[root@ncputility ~ hn_hub_rc]$ helm backup -n hnevocdgit01 -a none -t ncd-git -x http://cbur.apps.hnevocphub01.mnc002.mcc708/cbur
{
  &quot;kind&quot;: &quot;Status&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {},
  &quot;status&quot;: &quot;Failure&quot;,
  &quot;message&quot;: &quot;Failed to get helm release ncd-git in namespace hnevocdgit01&quot;,
  &quot;reason&quot;: &quot;&quot;,
  &quot;details&quot;: {},
  &quot;code&quot;: 500
}
[root@ncputility ~ hn_hub_rc]$ 
</code></pre>
<ol>
<li>to resolve this issue, get the values file and update the namespace scope list.  include git-server namespace too. </li>
</ol>
<pre><code>[root@ncputility ~ hn_hub_rc]$ helm get values ncd-cbur  -n hnevocdcbur01 &gt; rr.yaml

</code></pre>
<ol>
<li>retry it, it will work now</li>
</ol>
<pre><code>[root@ncputility ~ hn_hub_rc]$ helm backup -n hnevocdgit01 -a none -t ncd-git -x http://cbur.apps.hnevocphub01.mnc002.mcc708/cbur
{
  &quot;kind&quot;: &quot;Status&quot;,
  &quot;apiVersion&quot;: &quot;v1&quot;,
  &quot;metadata&quot;: {},
  &quot;status&quot;: &quot;Success&quot;,
  &quot;message&quot;: &quot;backupHelmRelease task = cc857932-d83d-4e2d-9493-1252595da3f2 is on!&quot;,
  &quot;reason&quot;: &quot;&quot;,
  &quot;details&quot;: {
    &quot;cc857932-d83d-4e2d-9493-1252595da3f2&quot;: {
      &quot;name&quot;: &quot;ncd-git&quot;,
      &quot;namespace&quot;: &quot;hnevocdgit01&quot;,
      &quot;timestamp&quot;: &quot;20250403005800&quot;,
      &quot;backup_data&quot;: {},
      &quot;helm_version&quot;: 3,
      &quot;request&quot;: &quot;backupHelmRelease&quot;
    }
  },
  &quot;code&quot;: 202
}
[root@ncputility ~ hn_hub_rc]$

</code></pre>
<h4 id="reference">Reference</h4>
<ol>
<li>NCDFM tickets</li>
<li>https://jiradc2.ext.net.nokia.com/browse/NCDFM-3023</li>
</ol></div>
            </div>
        </div>

        <footer class="col-md-12">
            <hr>
            <p>Documentation built with <a href="https://www.mkdocs.org/">MkDocs</a>.</p>
        </footer>
        <script src="../../js/bootstrap.bundle.min.js"></script>
        <script>
            var base_url = "../..",
                shortcuts = {"help": 191, "next": 78, "previous": 80, "search": 83};
        </script>
        <script src="../../js/base.js"></script>
        <script src="../../search/main.js"></script>

        <div class="modal" id="mkdocs_search_modal" tabindex="-1" role="dialog" aria-labelledby="searchModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="searchModalLabel">Search</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <p>From here you can search these documents. Enter your search terms below.</p>
                <form>
                    <div class="form-group">
                        <input type="search" class="form-control" placeholder="Search..." id="mkdocs-search-query" title="Type search term here">
                    </div>
                </form>
                <div id="mkdocs-search-results" data-no-results-text="No results found"></div>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div><div class="modal" id="mkdocs_keyboard_modal" tabindex="-1" role="dialog" aria-labelledby="keyboardModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="keyboardModalLabel">Keyboard Shortcuts</h4>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
              <table class="table">
                <thead>
                  <tr>
                    <th style="width: 20%;">Keys</th>
                    <th>Action</th>
                  </tr>
                </thead>
                <tbody>
                  <tr>
                    <td class="help shortcut"><kbd>?</kbd></td>
                    <td>Open this help</td>
                  </tr>
                  <tr>
                    <td class="next shortcut"><kbd>n</kbd></td>
                    <td>Next page</td>
                  </tr>
                  <tr>
                    <td class="prev shortcut"><kbd>p</kbd></td>
                    <td>Previous page</td>
                  </tr>
                  <tr>
                    <td class="search shortcut"><kbd>s</kbd></td>
                    <td>Search</td>
                  </tr>
                </tbody>
              </table>
            </div>
            <div class="modal-footer">
            </div>
        </div>
    </div>
</div>

    </body>
</html>
